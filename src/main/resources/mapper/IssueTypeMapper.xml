<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="io.choerodon.agile.infra.mapper.IssueTypeMapper">

    <!--<select id="fulltextSearch" resultType="io.choerodon.issue.domain.IssueType">-->
    <!--SELECT * FROM issue_type-->
    <!--WHERE 1=1-->
    <!--<if test="issueType.organizationId != null">-->
    <!--AND organization_id = #{issueType.organizationId}-->
    <!--</if>-->
    <!--<if test="issueType.name != null">-->
    <!--AND name LIKE concat('%',#{issueType.name},'%')-->
    <!--</if>-->
    <!--<if test="issueType.description != null">-->
    <!--AND description LIKE concat('%',#{issueType.description},'%')-->
    <!--</if>-->
    <!--<if test="param != null">-->
    <!--AND ( name LIKE concat('%',#{param},'%')-->
    <!--OR description LIKE concat('%',#{param},'%')-->
    <!--)-->
    <!--</if>-->
    <!--</select>-->

    <select id="queryByOrgId" resultType="io.choerodon.agile.infra.dto.IssueTypeDTO">
        SELECT
        t1.*
        FROM fd_issue_type t1
        LEFT JOIN fd_issue_type_extend t2 ON t1.id = t2.issue_type_id
        WHERE 1=1
        <choose>
            <when test="projectId == 0">
                AND t1.organization_id = #{organizationId}
                AND t1.project_id = #{projectId}
            </when>
            <otherwise>
                AND t1.id IN (
                    SELECT t2.id
                    FROM fd_issue_type t2
                    WHERE t2.organization_id = #{organizationId}
                    AND t2.project_id = #{projectId}
                    UNION
                    SELECT t3.id
                    FROM fd_issue_type t3
                    WHERE t3.organization_id = #{organizationId}
                    AND t3.project_id = 0
                    AND t3.source = 'system'
                )
            </otherwise>
        </choose>
        AND ifnull(t2.enabled, 1) = 1
    </select>

    <select id="queryBySchemeId" resultType="io.choerodon.agile.infra.dto.IssueTypeDTO">
        SELECT
        t.*,
        c.sequence
        FROM fd_issue_type t
        LEFT JOIN fd_issue_type_scheme_config c on c.issue_type_id = t.id
        WHERE 1=1
        <if test="organizationId != null">
            AND t.organization_id = #{organizationId}
        </if>
        <if test="schemeId != null">
            AND c.scheme_id = #{schemeId}
        </if>
        order by c.sequence
    </select>

    <select id="selectIssueTypeIds" resultType="java.lang.Long">
        select
        it.id
        from fd_issue_type it
        where it.organization_id = #{organizationId}
        <if test="issueTypeSearchVO.name != null">
            AND it.name LIKE concat('%',#{issueTypeSearchVO.name},'%')
        </if>
        <if test="issueTypeSearchVO.description != null">
            AND it.description LIKE concat('%',#{issueTypeSearchVO.description},'%')
        </if>
        <if test="issueTypeSearchVO.param != null">
            AND (it.name LIKE concat('%',#{issueTypeSearchVO.param},'%')
            OR it.description LIKE concat('%',#{issueTypeSearchVO.param},'%')
            )
        </if>
    </select>

    <resultMap id="issueTypeListMap" type="io.choerodon.agile.infra.dto.IssueTypeWithInfoDTO">
        <id property="id" column="it_id"/>
        <id property="name" column="it_name"/>
        <id property="description" column="it_description"/>
        <id property="icon" column="it_icon"/>
        <id property="colour" column="it_colour"/>
        <id property="organizationId" column="it_organization_id"/>
        <id property="initialize" column="it_is_initialize"/>
        <id property="objectVersionNumber" column="it_object_version_number"/>
        <id property="typeCode" column="it_type_code"/>
        <collection property="issueTypeSchemeRelationList" autoMapping="true"
                    ofType="io.choerodon.agile.infra.dto.IssueTypeSchemeRelationDTO">
            <id property="issueTypeSchemeId" column="itscits_scheme_id"/>
            <id property="issueTypeSchemeName" column="itscits_name"/>
        </collection>
    </resultMap>

    <select id="queryIssueTypeList" resultMap="issueTypeListMap">
        select
        it.id as it_id,
        it.name as it_name,
        it.description as it_description,
        it.icon as it_icon,
        it.colour as it_colour,
        it.organization_id as it_organization_id,
        it.type_code as it_type_code,
        it.is_initialize as it_is_initialize,
        it.object_version_number as it_object_version_number,
        itscits.scheme_id as itscits_scheme_id,
        itscits.name as itscits_name
        from fd_issue_type it
        left join
        (
        select
        itsc.issue_type_id,
        itsc.scheme_id,
        its.name
        from fd_issue_type_scheme_config itsc, fd_issue_type_scheme its
        where itsc.scheme_id = its.id
        ) itscits on it.id = itscits.issue_type_id
        where organization_id = #{organizationId}
        and it.id in
        <foreach collection="issueTypeIds" item="issueTypeId"
                 open="(" close=")" separator=",">
            #{issueTypeId}
        </foreach>
        order by it.id desc
    </select>

    <select id="selectByOrganizationIds" resultType="io.choerodon.agile.infra.dto.IssueTypeDTO">
        select * from fd_issue_type
        where organization_id in
        <foreach collection="organizationIds" item="organizationId" open="(" close=")" separator=",">
            #{organizationId}
        </foreach>
    </select>

    <select id="selectByTypeCode" resultType="io.choerodon.agile.infra.dto.IssueTypeDTO">
        select *
        from fd_issue_type
        where type_code = #{typeCode}
    </select>

    <select id="selectByOptions" resultType="io.choerodon.agile.api.vo.IssueTypeVO">
        select
        t1.*,
        t1.is_initialize as initialize,
        ifnull(t2.enabled, 1) as enabled
        from fd_issue_type t1
        left join fd_issue_type_extend t2 on t1.id = t2.issue_type_id
        where 1=1
        <choose>
            <when test="projectId == 0">
                and t1.organization_id = #{organizationId}
                and t1.project_id = #{projectId}
            </when>
            <otherwise>
                and t1.id in (
                    select t2.id
                    from fd_issue_type t2
                    where t2.organization_id = #{organizationId}
                    and t2.project_id = #{projectId}
                    union
                    select t3.id
                    from fd_issue_type t3
                    where t3.organization_id = #{organizationId}
                    and t3.project_id = 0
                    and t3.source = 'system'
                )
            </otherwise>
        </choose>
        <if test="issueTypeSearchVO != null">
            <if test="issueTypeSearchVO.typeCodes != null and issueTypeSearchVO.typeCodes.size > 0">
                and t1.type_code in
                <foreach collection="issueTypeSearchVO.typeCodes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="issueTypeSearchVO.issueTypeIds != null and issueTypeSearchVO.issueTypeIds.size > 0">
                and t1.id in
                <foreach collection="issueTypeSearchVO.issueTypeIds" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="issueTypeSearchVO.name != null">
                and t1.name like concat('%',#{issueTypeSearchVO.name},'%')
            </if>
            <if test="issueTypeSearchVO.description != null">
                and t1.description like concat('%',#{issueTypeSearchVO.description},'%')
            </if>
            <if test="issueTypeSearchVO.source != null">
                and t1.source = #{issueTypeSearchVO.source}
            </if>
            <if test="issueTypeSearchVO.enabled != null">
                and ifnull(t2.enabled, 1) = #{issueTypeSearchVO.enabled}
            </if>
            <if test="issueTypeSearchVO.referenced != null">
                and t1.referenced = #{issueTypeSearchVO.referenced}
            </if>
            <if test="issueTypeSearchVO.param != null">
                and (t1.name like concat('%',#{issueTypeSearchVO.param},'%')
                or t1.description like concat('%',#{issueTypeSearchVO.param},'%')
                or t1.source = #{issueTypeSearchVO.source}
                )
            </if>
        </if>
    </select>

    <select id="selectByReferenceId" resultType="io.choerodon.agile.infra.dto.IssueTypeDTO">
        select
        t1.id,
        t1.reference_id,
        t1.project_id
        from fd_issue_type t1
        where t1.organization_id = #{organizationId}
        and t1.project_id != 0
        and t1.reference_id in
        <foreach collection="ids" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="selectEnableReference" resultType="io.choerodon.agile.api.vo.IssueTypeVO">
        select
        t2.*
        from fd_issue_type t2
        where t2.organization_id = #{organizationId}
        and t2.project_id = 0
        and t2.source = 'organization'
        and t2.referenced = 1
        and t2.id not in (
            select
            t1.reference_id
            from fd_issue_type t1
            where t1.organization_id = #{organizationId}
            and t1.project_id = #{projectId}
            and t1.reference_id is not null
        )
    </select>

    <select id="selectIssueTypeIdsByOptions" resultType="java.lang.Long">
        SELECT id
        FROM fd_issue_type
        WHERE 1=1
        <choose>
            <when test="projectId == 0">
                AND t1.organization_id = #{organizationId}
                AND t1.project_id = #{projectId}
            </when>
            <otherwise>
                AND t1.id IN (
                    SELECT t2.id
                    FROM fd_issue_type t2
                    WHERE t2.organization_id = #{organizationId}
                    AND t2.project_id = #{projectId}
                    UNION
                    SELECT t3.id
                    FROM fd_issue_type t3
                    WHERE t3.organization_id = #{organizationId}
                    AND t3.project_id = 0
                    AND t3.source = 'system'
                )
            </otherwise>
        </choose>
        <if test="issueTypeCodes != null and issueTypeCodes.size > 0">
            AND type_code IN
              <foreach collection="issueTypeCodes" item="issueType" open="(" separator="," close=")">
                    #{issueType}
              </foreach>
        </if>
        AND source = #{source}
    </select>

</mapper>
